define(['jquery'], function($) {

    return {
        acoes_notas: function($course_id, $url) {
            // Notas
            $(function() {
                //Requisicao para listar as notas
                function requisicao_notas($url, $local, $acao = 1, $tmsg = 0, $msg) {
                    $.ajax({
                        type: "GET",
                        url: $url + $local,
                        data: {
                            "id": $course_id,
                            "acao": $acao,
                            "msg": $msg,
                            "tmsg": $tmsg
                        }
                    }).done(function(data) {
                        $(".conteudo_panel .container").html(data)
                    })
                }
                //Requisicao para adicionar uma nota
                function requisicao_add_notas($url, $local, $acao = 2, $valor, $cor) {
                    $.ajax({
                        type: "POST",
                        url: $url + $local,
                        data: {
                            "id": $course_id,
                            "acao": $acao,
                            "valor": $valor,
                            "cor": $cor
                        }
                    }).fail(function() {
                        requisicao_notas($url, '/theme/avasus3/cursos_menu_lateral/notas/get_notas.php', 1, 0, "Falha ao adicionar anotação!");
                    }).done(function(data) {
                        requisicao_notas($url, '/theme/avasus3/cursos_menu_lateral/notas/get_notas.php', 1, 1, "Nota adicionada com sucesso!");
                    })
                }
                //Adicionar uma nota
                $(document).on('click', "#add-note", function() {
                    if ($("#nota").val() != '') {
                        var nota = $("#nota").val();
                        var cor = $("#nota").parent('.single-note').children('.nota_cor').text();
                        requisicao_add_notas($url, '/theme/avasus3/cursos_menu_lateral/notas/add_notas.php', 2, nota, cor);
                    }
                });

                //Requisicao para remover uma nota
                function requisicao_del_notas($url, $local, $acao = 3, $valor) {
                    $.ajax({
                        type: "POST",
                        url: $url + $local,
                        data: {
                            "id": $course_id,
                            "acao": $acao,
                            "valor": $valor,
                        }
                    }).fail(function() {
                        requisicao_notas($url, '/theme/avasus3/cursos_menu_lateral/notas/get_notas.php', 1, 0, "Falha ao deletar anotação!");
                    }).done(function(data) {
                        requisicao_notas($url, '/theme/avasus3/cursos_menu_lateral/notas/get_notas.php', 1, 1, "Nota deletada com sucesso!");
                    })
                }
                //Remover uma nota
                function NotaDeleteClick() {
                    var val = $(this).parent('.row').children('.ni').text();
                    $(document).on('click', "#confirm_delete", function() {
                        requisicao_del_notas($url, '/theme/avasus3/cursos_menu_lateral/notas/del_notas.php', 3, val);
                    });
                }
                $(document).on('click', ".nota-delet", NotaDeleteClick);

                //Requisicao para atualizar uma nota
                function requisicao_update_notas($url, $local, $acao = 4, $valor, $id, $cor) {
                    $.ajax({
                        type: "POST",
                        url: $url + $local,
                        data: {
                            "id": $course_id,
                            "acao": $acao,
                            "valor": $valor,
                            "nid": $id,
                            "cor": $cor
                        }
                    }).fail(function() {
                        requisicao_notas($url, '/theme/avasus3/cursos_menu_lateral/notas/get_notas.php', 1, 0, "Falha ao atualizar a anotação!");
                    }).done(function(data) {
                        requisicao_notas($url, '/theme/avasus3/cursos_menu_lateral/notas/get_notas.php', 1, 1, "Nota atualizada com sucesso!");
                    })
                }
                //Editar uma nota
                function NotaSalvarEdit() {
                    valor_nota = $(this).parent('.meta').parent('.nota-item').children('.nota').children('.nota-editar').val();
                    var val = $(this).parent('.meta').parent('.nota-item').children('.row').children('.col').children('.row').children('.ni').text();
                    if ($(".nota-editar").val() != '') {
                        valor_nota = $(this).parent('.meta').parent('.nota-item').children('.nota').children('.nota-editar').val();
                        var cor = $(this).parent('.meta').parent('.nota-item').children('.nota_cor').text();
                        requisicao_update_notas($url, '/theme/avasus3/cursos_menu_lateral/notas/update_notas.php', 4, valor_nota, val, cor);
                    }
                }

                function onNotaItemClick() {
                    // Desabilita o icone de edicao
                    $(this).addClass("d-none");
                    // Abilita o icone de edicao de cor
                    $(this).parent('.row').children('.edit-nota-color').removeClass('d-none');
                    //Abilita o botao para salvar
                    $(this).parent('.row').parent('.col').parent('.row').parent('.nota-item').children('.meta').removeClass('d-none');
                    var local = $(this).parent('.row').parent('.col').parent('.row').parent('.nota-item').children('.nota').children('.nota-texto');
                    var text = local.children('.nota-textarea').text();
                    var html = "<textarea class='nota-editar'>" +
                        text + "</textarea>";
                    var local_nota = local.parent('.nota');
                    local_nota.html(html);
                    $(".save-edit-note").click(NotaSalvarEdit);
                }
                $(document).on('click', ".nota-edit", onNotaItemClick);



                //Alterar cor da nota ao adicionar
                function onaddNotaItemColorClick() {
                    $(this).parent('.row').parent('.single-note').children('.colors').addClass('openColors');
                }
                $(document).on('click', ".nota-color", onaddNotaItemColorClick);


                //Editar cor de uma 
                function onaeditNotaItemColorClick() {
                    $(this).parent('.row').parent('.col').parent('.row').parent('.single-note').children('.colors').addClass('openColors');
                }
                $(document).on('click', ".edit-nota-color", onaeditNotaItemColorClick);

                //Escolher cor
                function onNotaItemColorSelectClick() {
                    var selected = $(this).parent('.colors').children('.selected').attr("title");
                    $(this).parent('.colors').removeClass('openColors');
                    $(this).parent('.colors').children('.selected').removeClass('selected');
                    $(this).addClass('selected');
                    var cor = $(this).attr("title");
                    $(this).parent('.colors').parent('.single-note').children('.nota_cor').text(cor);
                    $(this).parent('.colors').parent('.single-note').removeClass(selected).addClass(cor);
                }
                $(document).on('click', ".circle", onNotaItemColorSelectClick);
            });
        }
    };
});